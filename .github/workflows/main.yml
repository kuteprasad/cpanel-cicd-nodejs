on: 
  push:
    branches:
      - main

name: 🚀 Deploy Backend on Push

jobs:
  backend-deploy:
    name: 🎉 Deploy Backend
    runs-on: ubuntu-latest
    environment: test01

    steps:
      - name: 🚚 Get latest code
        uses: actions/checkout@v4

      - name: 📂 Upload project via SCP
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          scp -r -i private_key.pem ./ sunshineiot@sunshineiot.in:/home/sunshineiot/cpanel-cicd-nodejs/

      - name: 🔁 Restart server (PM2 or Node)
        run: |
          ssh -i private_key.pem sunshineiot@sunshineiot.in << 'EOF'
            cd /home/sunshineiot/cpanel-cicd-nodejs
            npm install --omit=dev
            pm2 restart index || node index.js &
          EOF

    env:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

